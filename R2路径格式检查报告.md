# R2路径格式检查报告

## 📋 模板格式分析

根据用户提供的正确格式：

### 视频路径格式
```
videos/202602/06/6985b397cd9fd09939085942/b6bgf9/index.m3u8
```

**格式说明**:
- 前缀：`videos/`
- 日期目录：`202602/06/`（年月/日）
- Hash目录：`6985b397cd9fd09939085942/`
- 子目录：`b6bgf9/`
- 文件名：`index.m3u8`

### Poster路径格式
```
videos/202602/06/6985b397cd9fd09939085942/cover.jpg
```

**格式说明**:
- 与视频路径在同一父目录下
- 文件名：`cover.jpg`

### 图片路径格式
```
uploads/1770439953952_6a092732_1770439949656_46qhzw0fh.png
```

**格式说明**:
- 前缀：`uploads/`
- 文件名格式：`{timestamp}_{uuid}_{original_filename}`

## ✅ 已完成的修复

### 1. R2上传器路径处理 (`crawler/r2Uploader.js`)

**视频文件**:
- 优先使用传入的 `filename` 作为 `resource_key`
- 确保路径格式为 `videos/...`（不是 `uploads/videos/...`）
- 如果R2返回的路径包含 `uploads/` 前缀，自动移除

**图片文件**:
- 优先使用传入的 `filename` 作为 `resource_key`
- 确保图片路径包含 `uploads/` 前缀（除非是 `videos/` 目录下的文件）
- `videos/` 目录下的文件（如 `cover.jpg`）保持原样

### 2. 视频路径生成 (`crawler/m3u8Processor.js`)

**M3U8文件**:
- 路径：`videos/{articleId}/playlist.m3u8`
- TS文件：`videos/{articleId}/segment_001.ts`

**MP4文件**:
- 路径：`videos/{articleId}/video.mp4`

### 3. 封面图路径生成 (`crawler/taskQueue.js`)

**封面图**:
- 路径：`videos/{articleId}/cover.jpg`
- 与视频在同一目录下

### 4. 富文本生成 (`crawler/apiClient.js`)

**视频标签**:
- 视频路径：`videos/{articleId}/playlist.m3u8`
- Poster路径：`videos/{articleId}/cover.jpg`
- 确保路径格式正确

## 🔍 当前实现 vs 模板格式

### 当前实现
- 视频路径：`videos/{articleId}/playlist.m3u8`
- Poster路径：`videos/{articleId}/cover.jpg`

### 模板格式
- 视频路径：`videos/202602/06/6985b397cd9fd09939085942/b6bgf9/index.m3u8`
- Poster路径：`videos/202602/06/6985b397cd9fd09939085942/cover.jpg`

### 差异分析

1. **路径结构**:
   - 模板使用复杂的日期+hash+子目录结构
   - 当前实现使用简单的 `{articleId}` 目录结构

2. **文件名**:
   - 模板使用 `index.m3u8`
   - 当前实现使用 `playlist.m3u8`

## 💡 建议

如果视频不显示，可能的原因：

1. **路径格式差异**:
   - 虽然路径结构不同，但只要路径格式正确（`videos/...`），应该可以正常显示
   - 如果后端需要特定的路径格式，可能需要调整

2. **文件名差异**:
   - `playlist.m3u8` vs `index.m3u8` 可能不影响播放
   - 但如果后端有特殊要求，可以改为 `index.m3u8`

3. **R2返回的路径**:
   - 确保R2上传器优先使用传入的 `filename`
   - 确保路径格式正确（`videos/...` 而不是 `uploads/videos/...`）

## ✅ 验证要点

1. ✅ R2上传器优先使用传入的 `filename` 作为 `resource_key`
2. ✅ 视频路径格式：`videos/...`（不是 `uploads/videos/...`）
3. ✅ Poster路径格式：`videos/.../cover.jpg`（与视频在同一目录）
4. ✅ 图片路径格式：`uploads/...`（保持不变）
5. ✅ 富文本生成时路径格式正确

## 🎯 下一步

如果视频仍然不显示，建议：
1. 检查R2返回的实际路径格式
2. 检查后端对视频路径的要求
3. 考虑是否需要调整路径结构以匹配模板格式
